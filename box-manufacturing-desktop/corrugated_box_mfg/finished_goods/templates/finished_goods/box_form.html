{% extends 'finished_goods/base_finished_goods.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }} <!-- This preserves the CSS from the parent template -->
<link rel="stylesheet" href="{% static 'css/auto-suggest.css' %}">
<style>
    .calculation-steps {
        font-size: 14px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-top: 15px;
    }
    .calculation-formula {
        font-family: monospace;
        margin-bottom: 5px;
    }
    .constants-table td, .constants-table th {
        padding: 5px 10px;
    }
</style>
{% endblock %}

{% block finished_goods_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ object.id|yesno:"Edit,Create" }} Box Template</h1>
    <a href="{% url 'finished_goods:box-list' %}" class="btn btn-secondary">Back to List</a>
</div>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            <div class="row">
                <div class="col-md-6">
                    <h6>Box Dimensions</h6>
                    <div class="form-group">
                        <label for="{{ form.box_name.id_for_label }}">Box Name</label>
                        {{ form.box_name }}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.length.id_for_label }}">Length (cm)</label>
                                {{ form.length }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.breadth.id_for_label }}">Breadth (cm)</label>
                                {{ form.breadth }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.height.id_for_label }}">Height (cm)</label>
                                {{ form.height }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.flute_type.id_for_label }}">Flute Type</label>
                                {{ form.flute_type }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.num_plies.id_for_label }}">Number of Plies</label>
                                {{ form.num_plies }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h6>Paper Requirements</h6>
                    
                    <!-- Base 3-ply fields (always show) -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ paper_form.top_paper_gsm.id_for_label }}">Top Paper GSM</label>
                                {{ paper_form.top_paper_gsm }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ paper_form.top_paper_bf.id_for_label }}">Top Paper BF</label>
                                {{ paper_form.top_paper_bf }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ paper_form.bottom_paper_gsm.id_for_label }}">Bottom Paper GSM</label>
                                {{ paper_form.bottom_paper_gsm }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ paper_form.bottom_paper_bf.id_for_label }}">Bottom Paper BF</label>
                                {{ paper_form.bottom_paper_bf }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 5-ply fields (show when num_plies >= 5) -->
                    <div class="flute-paper-fields" style="display:none;">
                        <hr>
                        <h6>5-Ply Paper Requirements</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper_gsm">Flute Paper GSM</label>
                                    <input type="number" name="flute_paper_gsm" class="form-control" id="id_flute_paper_gsm" value="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper_bf">Flute Paper BF</label>
                                    <input type="number" name="flute_paper_bf" class="form-control" id="id_flute_paper_bf" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 7-ply fields (show when num_plies >= 7) -->
                    <div class="seven-ply-fields" style="display:none;">
                        <hr>
                        <h6>7-Ply Additional Paper Requirements</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper1_gsm">Flute Paper 1 GSM</label>
                                    <input type="number" name="flute_paper1_gsm" class="form-control" id="id_flute_paper1_gsm" value="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper1_bf">Flute Paper 1 BF</label>
                                    <input type="number" name="flute_paper1_bf" class="form-control" id="id_flute_paper1_bf" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_middle_paper_gsm">Middle Paper GSM</label>
                                    <input type="number" name="middle_paper_gsm" class="form-control" id="id_middle_paper_gsm" value="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_middle_paper_bf">Middle Paper BF</label>
                                    <input type="number" name="middle_paper_bf" class="form-control" id="id_middle_paper_bf" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper2_gsm">Flute Paper 2 GSM</label>
                                    <input type="number" name="flute_paper2_gsm" class="form-control" id="id_flute_paper2_gsm" value="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper2_bf">Flute Paper 2 BF</label>
                                    <input type="number" name="flute_paper2_bf" class="form-control" id="id_flute_paper2_bf" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group mt-3">
                <button type="button" id="calculate-btn" class="btn btn-info">Calculate</button>
                <button type="submit" class="btn btn-primary">Save Box Template</button>
                <a href="{% url 'finished_goods:box-list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
        
        <div id="calculation-results" class="mt-4">
            <!-- Results will be displayed here -->
        </div>
        
        <!-- Constants and Calculation Details Section -->
        <div id="calculation-details" style="display:none;" class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>Constants Used in Calculations</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm constants-table">
                        <tbody>
                            <tr>
                                <th>Length Shrinkage Factor</th>
                                <td><span id="length-shrinkage-factor">1.006</span></td>
                            </tr>
                            <tr>
                                <th>Breadth Shrinkage Factor</th>
                                <td><span id="breadth-shrinkage-factor">1.006</span></td>
                            </tr>
                            <tr>
                                <th>Height Shrinkage Factor</th>
                                <td><span id="height-shrinkage-factor">1.0112</span></td>
                            </tr>
                            <tr>
                                <th>Flute Take-Up Factor (TUF)</th>
                                <td><span id="flute-tuf">1.35</span></td>
                            </tr>
                            <tr>
                                <th>Paper Cost per kg (₹)</th>
                                <td><span id="paper-cost-per-kg">80</span></td>
                            </tr>
                            <tr>
                                <th>Labor Cost Percentage</th>
                                <td><span id="labor-cost-percentage">30%</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5>Calculation Formulas & Steps</h5>
                </div>
                <div class="card-body">
                    <div class="calculation-steps">
                        <h6>Dimensions with Shrinkage</h6>
                        <div id="dimension-formulas">
                            <!-- Dimension formulas will be displayed here -->
                        </div>
                        
                        <h6 class="mt-3">Board Size Calculations</h6>
                        <div id="board-size-formulas">
                            <!-- Board size formulas will be displayed here -->
                        </div>
                        
                        <h6 class="mt-3">Paper Weight Calculations</h6>
                        <div id="paper-weight-formulas">
                            <!-- Paper weight formulas will be displayed here -->
                        </div>
                        
                        <h6 class="mt-3">Cost Calculations</h6>
                        <div id="cost-formulas">
                            <!-- Cost calculation formulas will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/auto-suggest.js' %}"></script>
<script src="{% static 'finished_goods/js/box_calculations.js' %}"></script>
<script>
function updatePaperRequirements(numPlies) {
    const paperFields = document.querySelectorAll('.paper-field');
    paperFields.forEach(field => {
        const requiredPly = parseInt(field.dataset.ply);
        field.style.display = requiredPly <= numPlies ? 'block' : 'none';
    });
}

function updateCalculations() {
    const length = document.getElementById('id_length').value;
    const breadth = document.getElementById('id_breadth').value;
    const height = document.getElementById('id_height').value;
    
    if (length && breadth && height) {
        fetch(`/finished-goods/calculations/?length=${length}&breadth=${breadth}&height=${height}`)
            .then(response => response.json())
            .then(data => {
                // Existing dimension calculations
                document.getElementById('calc-length').textContent = data.dimensions.length.toFixed(4);
                document.getElementById('calc-breadth').textContent = data.dimensions.breadth.toFixed(4);
                document.getElementById('calc-height').textContent = data.dimensions.height.toFixed(4);
                document.getElementById('calc-flute').textContent = data.dimensions.flute_size.toFixed(4);
                document.getElementById('calc-full-length').textContent = data.board_sizes.full_length.toFixed(4);
                document.getElementById('calc-half-length').textContent = data.board_sizes.half_length.toFixed(4);
                document.getElementById('calc-reel-1up').textContent = data.board_sizes.reel_size_1up.toFixed(4);
                document.getElementById('calc-reel-2up').textContent = data.board_sizes.reel_size_2up.toFixed(4);
                document.getElementById('calc-ups').textContent = data.ups;
                
                // Add production cost calculations
                if (data.cost_estimates) {
                    document.getElementById('calc-material-cost').textContent = '₹' + data.cost_estimates.material_cost.toFixed(6);
                    document.getElementById('calc-labor-cost').textContent = '₹' + data.cost_estimates.labor_cost.toFixed(6);
                    document.getElementById('calc-production-cost').textContent = '₹' + data.cost_estimates.total_cost.toFixed(6);
                }
            });
    }
}

// Replace the existing updatePaperFieldsVisibility function with this:
function updatePaperFieldsVisibility() {
    const numPlies = parseInt(document.getElementById('id_num_plies').value) || 3;
    const flutePaperFields = document.querySelector('.flute-paper-fields');
    const sevenPlyFields = document.querySelector('.seven-ply-fields');
    
    // Basic logic for showing/hiding sections
    if (numPlies < 5) {
        // For 3-ply, hide both 5-ply and 7-ply fields
        flutePaperFields.style.display = 'none';
        sevenPlyFields.style.display = 'none';
    } else if (numPlies >= 5 && numPlies < 7) {
        // For 5-ply, show only 5-ply fields
        flutePaperFields.style.display = 'block';
        sevenPlyFields.style.display = 'none';
        
        // Enable input fields for 5-ply section
        enableFormFields(flutePaperFields, true);
    } else if (numPlies >= 7) {
        // For 7-ply, hide 5-ply fields and show 7-ply fields
        flutePaperFields.style.display = 'none';
        sevenPlyFields.style.display = 'block';
        
        // Disable 5-ply fields and enable 7-ply fields
        enableFormFields(flutePaperFields, false);
        enableFormFields(sevenPlyFields, true);
    }
}

// Add this helper function to enable/disable form fields
function enableFormFields(container, enable) {
    const inputs = container.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (enable) {
            input.removeAttribute('disabled');
            input.classList.remove('disabled-field');
        } else {
            input.setAttribute('disabled', 'disabled');
            input.classList.add('disabled-field');
        }
    });
}

// Display calculation formulas and steps
function displayCalculationDetails(data) {
    // Show calculation details section
    document.getElementById('calculation-details').style.display = 'block';
    
    // Update dimension formulas
    const dimensionFormulas = document.getElementById('dimension-formulas');
    dimensionFormulas.innerHTML = '';
    for (const [key, formula] of Object.entries(data.formulas.dimensions)) {
        const formulaDiv = document.createElement('div');
        formulaDiv.className = 'calculation-formula';
        formulaDiv.textContent = formula;
        dimensionFormulas.appendChild(formulaDiv);
    }
    
    // Update board size formulas
    const boardSizeFormulas = document.getElementById('board-size-formulas');
    boardSizeFormulas.innerHTML = '';
    for (const [key, formula] of Object.entries(data.formulas.board_sizes)) {
        const formulaDiv = document.createElement('div');
        formulaDiv.className = 'calculation-formula';
        formulaDiv.textContent = formula;
        boardSizeFormulas.appendChild(formulaDiv);
    }
    
    // Update paper weight formulas
    const paperWeightFormulas = document.getElementById('paper-weight-formulas');
    paperWeightFormulas.innerHTML = '';
    
    // Add surface area formula
    const surfaceAreaFormula = document.createElement('div');
    surfaceAreaFormula.className = 'calculation-formula';
    surfaceAreaFormula.textContent = 'Surface Area: ' + data.formulas.surface_area;
    paperWeightFormulas.appendChild(surfaceAreaFormula);
    
    // Add paper weight formulas
    for (const [key, formula] of Object.entries(data.formulas.paper_weights)) {
        const formulaDiv = document.createElement('div');
        formulaDiv.className = 'calculation-formula';
        formulaDiv.textContent = formula;
        paperWeightFormulas.appendChild(formulaDiv);
    }
    
    // Update cost formulas
    const costFormulas = document.getElementById('cost-formulas');
    costFormulas.innerHTML = '';
    for (const [key, formula] of Object.entries(data.formulas.costs)) {
        const formulaDiv = document.createElement('div');
        formulaDiv.className = 'calculation-formula';
        formulaDiv.textContent = formula;
        costFormulas.appendChild(formulaDiv);
    }
    
    // Update constants if provided
    if (data.constants) {
        document.getElementById('length-shrinkage-factor').textContent = data.constants.length_shrinkage_factor;
        document.getElementById('breadth-shrinkage-factor').textContent = data.constants.breadth_shrinkage_factor;
        document.getElementById('height-shrinkage-factor').textContent = data.constants.height_shrinkage_factor;
        document.getElementById('flute-tuf').textContent = data.constants.flute_tuf;
        document.getElementById('paper-cost-per-kg').textContent = data.constants.paper_cost_per_kg;
        document.getElementById('labor-cost-percentage').textContent = (data.constants.labor_cost_percentage * 100) + '%';
    }
}

// Ensure the document ready function includes calling this
document.addEventListener('DOMContentLoaded', function() {
    // Make sure these selectors match your actual DOM elements
    const numPliesSelect = document.getElementById('id_num_plies');
    const calculateBtn = document.getElementById('calculate-btn');
    
    // Set default to 3 plies if not already set
    if (!numPliesSelect.value) {
        numPliesSelect.value = "3";
    }
    
    // Add change event listener
    numPliesSelect.addEventListener('change', updatePaperFieldsVisibility);
    
    // Add these two lines to ensure the flute paper fields are properly rendered
    document.querySelectorAll('.flute-paper-fields input, .seven-ply-fields input').forEach(input => {
        input.classList.add('form-control');
    });
    
    // Call function on page load to set initial state
    updatePaperFieldsVisibility();
    
    // Override the calculate button click handler
    if (calculateBtn) {
        calculateBtn.addEventListener('click', function() {
            const length = document.getElementById('id_length').value;
            const breadth = document.getElementById('id_breadth').value;
            const height = document.getElementById('id_height').value;
            const fluteType = document.getElementById('id_flute_type').value;
            const numPlies = parseInt(document.getElementById('id_num_plies').value) || 3;
            
            if (!length || !breadth || !height) {
                alert('Please enter all dimensions');
                return;
            }
            
            // Collect GSM values based on ply count
            const paperGsms = {
                top_paper_gsm: parseFloat(document.getElementById('id_top_paper_gsm').value) || 0,
                bottom_paper_gsm: parseFloat(document.getElementById('id_bottom_paper_gsm').value) || 0
            };
            
            if (numPlies >= 5) {
                paperGsms.flute_paper_gsm = parseFloat(document.getElementById('id_flute_paper_gsm').value) || 0;
            }
            
            if (numPlies === 7) {
                paperGsms.flute_paper1_gsm = parseFloat(document.getElementById('id_flute_paper1_gsm').value) || 0;
                paperGsms.middle_paper_gsm = parseFloat(document.getElementById('id_middle_paper_gsm').value) || 0;
                paperGsms.flute_paper2_gsm = parseFloat(document.getElementById('id_flute_paper2_gsm').value) || 0;
            }
            
            // Build query string
            const params = new URLSearchParams({
                length: length,
                breadth: breadth,
                height: height,
                flute_type: fluteType,
                num_plies: numPlies,
                ...paperGsms
            });
            
            // Make AJAX request to get calculations
            fetch(`/finished-goods/calculations/?${params}`)
                .then(response => response.json())
                .then(data => {
                    // Create results HTML
                    const resultsHTML = `
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5>Box Production Specifications</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Dimensions with Shrinkage</h6>
                                        <table class="table table-sm">
                                            <tr>
                                                <th>Length (cm)</th>
                                                <td>${data.dimensions.length.toFixed(4)}</td>
                                            </tr>
                                            <tr>
                                                <th>Breadth (cm)</th>
                                                <td>${data.dimensions.breadth.toFixed(4)}</td>
                                            </tr>
                                            <tr>
                                                <th>Height (cm)</th>
                                                <td>${data.dimensions.height.toFixed(4)}</td>
                                            </tr>
                                            <tr>
                                                <th>Flute Size (cm)</th>
                                                <td>${data.dimensions.flute_size.toFixed(4)}</td>
                                            </tr>
                                        </table>
                                        
                                        <h6>Board Specifications</h6>
                                        <table class="table table-sm">
                                            <tr>
                                                <th>Full Length (in)</th>
                                                <td>${data.board_sizes.full_length_in.toFixed(4)}</td>
                                            </tr>
                                            <tr>
                                                <th>Half Length (in)</th>
                                                <td>${data.board_sizes.half_length_in.toFixed(4)}</td>
                                            </tr>
                                            <tr>
                                                <th>Reel Size 1-Up (in)</th>
                                                <td>${data.board_sizes.reel_size_1up.toFixed(4)}</td>
                                            </tr>
                                            <tr>
                                                <th>Reel Size 2-Up (in)</th>
                                                <td>${data.board_sizes.reel_size_2up.toFixed(4)}</td>
                                            </tr>
                                            <tr>
                                                <th>UPS (Production Mode)</th>
                                                <td>${data.ups}</td>
                                            </tr>
                                        </table>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6>Paper Requirements</h6>
                                        <table class="table table-sm">
                                            <tr>
                                                <th>Total Surface Area</th>
                                                <td>${data.total_area.toFixed(6)} m²</td>
                                            </tr>
                                            ${Object.entries(data.paper_weights).map(([key, value]) => `
                                                <tr>
                                                    <th>${key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</th>
                                                    <td>${value.toFixed(4)} kg</td>
                                                </tr>
                                            `).join('')}
                                            <tr>
                                                <th>Total Material Weight</th>
                                                <td>${data.total_material_weight.toFixed(6)} kg</td>
                                            </tr>
                                        </table>
                                        
                                        <h6>Cost Estimates</h6>
                                        <table class="table table-sm">
                                            <tr>
                                                <th>Material Cost</th>
                                                <td>₹${data.cost_estimates.material_cost.toFixed(6)}</td>
                                            </tr>
                                            <tr>
                                                <th>Labor Cost</th>
                                                <td>₹${data.cost_estimates.labor_cost.toFixed(6)}</td>
                                            </tr>
                                            <tr class="table-primary">
                                                <th>Total Production Cost</th>
                                                <td>₹${data.cost_estimates.total_cost.toFixed(6)}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Update the results div
                    document.getElementById('calculation-results').innerHTML = resultsHTML;
                    
                    // Display calculation details
                    displayCalculationDetails(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('calculation-results').innerHTML = `
                        <div class="alert alert-danger">
                            Error calculating box requirements. Please try again.
                        </div>
                    `;
                });
        });
    }
});
</script>
{% endblock %}