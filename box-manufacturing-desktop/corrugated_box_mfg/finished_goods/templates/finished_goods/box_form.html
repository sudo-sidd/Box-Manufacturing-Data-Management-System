{% extends 'finished_goods/base_finished_goods.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }} <!-- This preserves the CSS from the parent template -->
<link rel="stylesheet" href="{% static 'css/auto-suggest.css' %}">
{% endblock %}

{% block finished_goods_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ object.id|yesno:"Edit,Create" }} Box Template</h1>
    <a href="{% url 'finished_goods:box-list' %}" class="btn btn-secondary">Back to List</a>
</div>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            <div class="row">
                <div class="col-md-6">
                    <h6>Box Dimensions</h6>
                    <div class="form-group">
                        <label for="{{ form.box_name.id_for_label }}">Box Name</label>
                        {{ form.box_name }}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.length.id_for_label }}">Length (cm)</label>
                                {{ form.length }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.breadth.id_for_label }}">Breadth (cm)</label>
                                {{ form.breadth }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.height.id_for_label }}">Height (cm)</label>
                                {{ form.height }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.flute_type.id_for_label }}">Flute Type</label>
                                {{ form.flute_type }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.num_plies.id_for_label }}">Number of Plies</label>
                                {{ form.num_plies }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="{{ form.order_quantity.id_for_label }}">Order Quantity</label>
                                {{ form.order_quantity }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.print_color.id_for_label }}">Print Color</label>
                        {{ form.print_color }}
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h6>Paper Requirements</h6>
                    
                    <!-- Base 3-ply fields (always show) -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ paper_form.top_paper_gsm.id_for_label }}">Top Paper GSM</label>
                                {{ paper_form.top_paper_gsm }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ paper_form.top_paper_bf.id_for_label }}">Top Paper BF</label>
                                {{ paper_form.top_paper_bf }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ paper_form.bottom_paper_gsm.id_for_label }}">Bottom Paper GSM</label>
                                {{ paper_form.bottom_paper_gsm }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ paper_form.bottom_paper_bf.id_for_label }}">Bottom Paper BF</label>
                                {{ paper_form.bottom_paper_bf }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 5-ply fields (show when num_plies >= 5) -->
                    <div class="flute-paper-fields" style="display:none;">
                        <hr>
                        <h6>5-Ply Paper Requirements</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper_gsm">Flute Paper GSM</label>
                                    <input type="number" name="flute_paper_gsm" class="form-control" id="id_flute_paper_gsm" value="100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper_bf">Flute Paper BF</label>
                                    <input type="number" name="flute_paper_bf" class="form-control" id="id_flute_paper_bf" value="16">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 7-ply fields (show when num_plies >= 7) -->
                    <div class="seven-ply-fields" style="display:none;">
                        <hr>
                        <h6>7-Ply Additional Paper Requirements</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper1_gsm">Flute Paper 1 GSM</label>
                                    <input type="number" name="flute_paper1_gsm" class="form-control" id="id_flute_paper1_gsm" value="100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper1_bf">Flute Paper 1 BF</label>
                                    <input type="number" name="flute_paper1_bf" class="form-control" id="id_flute_paper1_bf" value="16">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_middle_paper_gsm">Middle Paper GSM</label>
                                    <input type="number" name="middle_paper_gsm" class="form-control" id="id_middle_paper_gsm" value="100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_middle_paper_bf">Middle Paper BF</label>
                                    <input type="number" name="middle_paper_bf" class="form-control" id="id_middle_paper_bf" value="16">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper2_gsm">Flute Paper 2 GSM</label>
                                    <input type="number" name="flute_paper2_gsm" class="form-control" id="id_flute_paper2_gsm" value="100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_flute_paper2_bf">Flute Paper 2 BF</label>
                                    <input type="number" name="flute_paper2_bf" class="form-control" id="id_flute_paper2_bf" value="16">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group mt-3">
                <button type="button" id="calculate-btn" class="btn btn-info">Calculate</button>
                <button type="submit" class="btn btn-primary">Save Box Template</button>
                <a href="{% url 'finished_goods:box-list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
        
        <div id="calculation-results" class="mt-4">
            <!-- Results will be displayed here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/auto-suggest.js' %}"></script>
<script src="{% static 'finished_goods/js/box_calculations.js' %}"></script>
<script>
function updatePaperRequirements(numPlies) {
    const paperFields = document.querySelectorAll('.paper-field');
    paperFields.forEach(field => {
        const requiredPly = parseInt(field.dataset.ply);
        field.style.display = requiredPly <= numPlies ? 'block' : 'none';
    });
}

function updateCalculations() {
    const length = document.getElementById('id_length').value;
    const breadth = document.getElementById('id_breadth').value;
    const height = document.getElementById('id_height').value;
    
    if (length && breadth && height) {
        fetch(`/finished-goods/calculations/?length=${length}&breadth=${breadth}&height=${height}`)
            .then(response => response.json())
            .then(data => {
                // Existing dimension calculations
                document.getElementById('calc-length').textContent = data.dimensions.length.toFixed(2);
                document.getElementById('calc-breadth').textContent = data.dimensions.breadth.toFixed(2);
                document.getElementById('calc-height').textContent = data.dimensions.height.toFixed(2);
                document.getElementById('calc-flute').textContent = data.dimensions.flute_size.toFixed(2);
                document.getElementById('calc-full-length').textContent = data.board_sizes.full_length.toFixed(2);
                document.getElementById('calc-half-length').textContent = data.board_sizes.half_length.toFixed(2);
                document.getElementById('calc-reel-1up').textContent = data.board_sizes.reel_size_1up.toFixed(2);
                document.getElementById('calc-reel-2up').textContent = data.board_sizes.reel_size_2up.toFixed(2);
                document.getElementById('calc-ups').textContent = data.ups;
                
                // Add production cost calculations
                if (data.cost_estimates) {
                    document.getElementById('calc-material-cost').textContent = '₹' + data.cost_estimates.material_cost.toFixed(2);
                    document.getElementById('calc-labor-cost').textContent = '₹' + data.cost_estimates.labor_cost.toFixed(2);
                    document.getElementById('calc-production-cost').textContent = '₹' + data.cost_estimates.production_cost.toFixed(2);
                }
            });
    }
}

// Replace the existing updatePaperFieldsVisibility function with this:
function updatePaperFieldsVisibility() {
    const numPlies = parseInt(document.getElementById('id_num_plies').value) || 3;
    const flutePaperFields = document.querySelector('.flute-paper-fields');
    const sevenPlyFields = document.querySelector('.seven-ply-fields');
    
    // Basic logic for showing/hiding sections
    if (numPlies < 5) {
        // For 3-ply, hide both 5-ply and 7-ply fields
        flutePaperFields.style.display = 'none';
        sevenPlyFields.style.display = 'none';
    } else if (numPlies >= 5 && numPlies < 7) {
        // For 5-ply, show only 5-ply fields
        flutePaperFields.style.display = 'block';
        sevenPlyFields.style.display = 'none';
        
        // Enable input fields for 5-ply section
        enableFormFields(flutePaperFields, true);
    } else if (numPlies >= 7) {
        // For 7-ply, hide 5-ply fields and show 7-ply fields
        flutePaperFields.style.display = 'none';
        sevenPlyFields.style.display = 'block';
        
        // Disable 5-ply fields and enable 7-ply fields
        enableFormFields(flutePaperFields, false);
        enableFormFields(sevenPlyFields, true);
    }
}

// Add this helper function to enable/disable form fields
function enableFormFields(container, enable) {
    const inputs = container.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (enable) {
            input.removeAttribute('disabled');
            input.classList.remove('disabled-field');
        } else {
            input.setAttribute('disabled', 'disabled');
            input.classList.add('disabled-field');
        }
    });
}

// Ensure the document ready function includes calling this
document.addEventListener('DOMContentLoaded', function() {
    // Make sure these selectors match your actual DOM elements
    const numPliesSelect = document.getElementById('id_num_plies');
    
    // Set default to 3 plies if not already set
    if (!numPliesSelect.value) {
        numPliesSelect.value = "3";
    }
    
    // Add change event listener
    numPliesSelect.addEventListener('change', updatePaperFieldsVisibility);
    
    // Add these two lines to ensure the flute paper fields are properly rendered
    document.querySelectorAll('.flute-paper-fields input, .seven-ply-fields input').forEach(input => {
        input.classList.add('form-control');
    });
    
    // Call function on page load to set initial state
    updatePaperFieldsVisibility();
    
    // Add existing calculation setup code here...
});
</script>
{% endblock %}